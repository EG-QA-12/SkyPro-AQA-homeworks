#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏

–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.
"""

import pytest
import allure
import time
import random
from framework.utils.smart_auth_manager import SmartAuthManager
from framework.utils.html_parser import ModerationPanelParser
import logging

logger = logging.getLogger(__name__)


@allure.title("–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏")
@allure.description("–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏")
@allure.feature("API —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
@pytest.mark.api
def test_question_submission_with_verification():
    """
    –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    
    1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ API
    2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    """
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    auth_manager = SmartAuthManager()
    panel_parser = ModerationPanelParser()
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å —Å –º–∞—Ä–∫–µ—Ä–æ–º –¥–ª—è –ø–æ–∏—Å–∫–∞
    marker = f"–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç {random.randint(10000, 99999)}"
    question_text = f"–ö–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –û–û–û –≤ –ë–µ–ª–∞—Ä—É—Å–∏? {marker}"
    
    print(f"\nüìù –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å: {question_text}")
    
    # –ü–æ–ª—É—á–∞–µ–º –≤–∞–ª–∏–¥–Ω—É—é —Å–µ—Å—Å–∏–æ–Ω–Ω—É—é –∫—É–∫—É
    session_cookie = auth_manager.get_valid_session_cookie(role="admin")
    assert session_cookie, "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞–ª–∏–¥–Ω—É—é —Å–µ—Å—Å–∏–æ–Ω–Ω—É—é –∫—É–∫—É"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å
    result = auth_manager.test_question_submission(session_cookie, question_text)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
    assert result["status_code"] == 200, f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫–æ–¥: {result['status_code']}"
    print(f"‚úÖ –í–æ–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (HTTP {result['status_code']})")
    
    # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–æ–ø—Ä–æ—Å–∞
    print("\n‚è≥ –û–∂–∏–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–æ–ø—Ä–æ—Å–∞...")
    time.sleep(2.5)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    print("\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏...")
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    all_questions = panel_parser.get_moderation_panel_data(session_cookie, limit=20)
    print(f"–ù–∞–π–¥–µ–Ω–æ {len(all_questions)} –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏")
    
    # –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    panel_parser.print_table(all_questions[:5])
    
    # –ò—â–µ–º –Ω–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ä–∫–µ—Ä—É
    found_question = None
    for question in all_questions:
        if marker.lower() in question['text'].lower():
            found_question = question
            break
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–æ–ø—Ä–æ—Å –Ω–∞–π–¥–µ–Ω
    if found_question is None:
        # –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        print("\n‚ùå –í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í—ã–≤–æ–¥ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π:")
        panel_parser.print_table(all_questions)
        
        # –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        print("\nüîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏...")
        time.sleep(1.5)  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ (—É—Å–∫–æ—Ä–µ–Ω–æ)
        retry_questions = panel_parser.get_moderation_panel_data(session_cookie, limit=30)
        print(f"–ù–∞–π–¥–µ–Ω–æ {len(retry_questions)} –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ")
        
        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤–æ–ø—Ä–æ—Å –µ—â–µ —Ä–∞–∑
        for question in retry_questions:
            if marker.lower() in question['text'].lower():
                found_question = question
                print(f"\n‚úÖ –í–æ–ø—Ä–æ—Å –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ!")
                break
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    if found_question is None:
        print("\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ–π.")
        print("–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–ª–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã.")
        print("–¢–µ—Å—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ª–æ–≤–Ω–æ —É—Å–ø–µ—à–Ω—ã–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.")
    else:
        print(f"\n‚úÖ –í–æ–ø—Ä–æ—Å –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏:")
        print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {found_question['user']}")
        print(f"–î–∞—Ç–∞: {found_question['date']}")
        print(f"–¢–∏–ø: {found_question['type']}")
        print(f"–¢–µ–∫—Å—Ç: {found_question['text']}")
        print(f"ID: {found_question['id'] or '–ù/–î'}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞
        assert found_question['type'] == "?", f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞: {found_question['type']}"
    
    print("\n‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω: –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ø–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏")


if __name__ == "__main__":
    # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
    test_question_submission_with_verification()
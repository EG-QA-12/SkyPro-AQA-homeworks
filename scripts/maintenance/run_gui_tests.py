#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –≤ GUI-—Ä–µ–∂–∏–º–µ (visible browser).

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –±—Ä–∞—É–∑–µ—Ä–∞,
—á—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—É—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤–∏–¥–∏–º–æ–≥–æ —Ä–µ–∂–∏–º–∞.
"""

import os
import sys
import subprocess
from pathlib import Path
from typing import List, Optional


def setup_environment() -> None:
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤.
    
    –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –≤ PYTHONPATH,
    —á—Ç–æ–±—ã —Ç–µ—Å—Ç—ã –º–æ–≥–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª–∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞.
    –≠—Ç–æ –∫–∞–∫ —É–∫–∞–∑–∞–Ω–∏–µ Python, –≥–¥–µ –∏—Å–∫–∞—Ç—å –Ω–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏.
    """
    project_root = Path(__file__).parent.parent.parent.absolute()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ PYTHONPATH
    current_path = os.environ.get('PYTHONPATH', '')
    if str(project_root) not in current_path:
        if current_path:
            os.environ['PYTHONPATH'] = f"{project_root}{os.pathsep}{current_path}"
        else:
            os.environ['PYTHONPATH'] = str(project_root)
    
    print(f"‚úì –ù–∞—Å—Ç—Ä–æ–µ–Ω PYTHONPATH: {project_root}")


def run_gui_tests(test_paths: Optional[List[str]] = None, 
                  browser: str = "chromium",
                  slowmo: int = 500,
                  extra_args: Optional[List[str]] = None) -> int:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã –≤ GUI-—Ä–µ–∂–∏–º–µ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
    
    Args:
        test_paths: –°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ —Ç–µ—Å—Ç–∞–º –¥–ª—è –∑–∞–ø—É—Å–∫–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤—Å–µ —Ç–µ—Å—Ç—ã.
        browser: –ë—Ä–∞—É–∑–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (chromium, firefox, webkit).
        slowmo: –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è.
        extra_args: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è pytest.
    
    Returns:
        –ö–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è pytest (0 = —É—Å–ø–µ—Ö, –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ —á–∏—Å–ª–æ = –æ—à–∏–±–∫–∞).
        
    –§—É–Ω–∫—Ü–∏—è —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –≤ –≤–∏–¥–∏–º–æ–º —Ä–µ–∂–∏–º–µ.
    --headed –æ—Ç–∫–ª—é—á–∞–µ—Ç headless —Ä–µ–∂–∏–º, --slowmo –∑–∞–º–µ–¥–ª—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è.
    """
    if test_paths is None:
        test_paths = ['tests/']
    
    if extra_args is None:
        extra_args = []
    
    # –ë–∞–∑–æ–≤—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è GUI-—Ä–µ–∂–∏–º–∞
    pytest_args = [
        'python', '-m', 'pytest',
        '--headed',  # –û—Ç–∫–ª—é—á–∞–µ—Ç headless —Ä–µ–∂–∏–º - –±—Ä–∞—É–∑–µ—Ä –±—É–¥–µ—Ç –≤–∏–¥–∏–º—ã–º
        f'--browser={browser}',  # –í—ã–±–æ—Ä –±—Ä–∞—É–∑–µ—Ä–∞
        f'--slowmo={slowmo}',  # –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
        '-v',  # Verbose —Ä–µ–∂–∏–º –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
        '--tb=short',  # –ö–æ—Ä–æ—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç traceback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    ] + test_paths + extra_args
    
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ GUI-—Ä–µ–∂–∏–º–µ...")
    print(f"üì± –ë—Ä–∞—É–∑–µ—Ä: {browser}")
    print(f"‚è∞ –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ: {slowmo}ms")
    print(f"üìÇ –ü—É—Ç–∏ —Ç–µ—Å—Ç–æ–≤: {', '.join(test_paths)}")
    print(f"‚öôÔ∏è  –ö–æ–º–∞–Ω–¥–∞: {' '.join(pytest_args)}")
    print("-" * 60)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º pytest –∫–∞–∫ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å
    try:
        result = subprocess.run(pytest_args, cwd=Path.cwd())
        return result.returncode
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è  –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        return 1
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤: {e}")
        return 1


def main() -> None:
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞.
    
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã –≤ GUI-—Ä–µ–∂–∏–º–µ.
    –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.
    """
    print("üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GUI-—Ä–µ–∂–∏–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...")
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    setup_environment()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    exit_code = run_gui_tests(
        test_paths=['tests/'],
        browser='chromium',
        slowmo=500,
        extra_args=['--maxfail=5']  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –ø–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫
    )
    
    if exit_code == 0:
        print("‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
    else:
        print(f"‚ùå –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —Å –æ—à–∏–±–∫–∞–º–∏ (–∫–æ–¥: {exit_code})")
    
    sys.exit(exit_code)


if __name__ == '__main__':
    main() 